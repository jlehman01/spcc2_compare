---
title: "POI Services Analysis & Mapping"
output:
  html_document:
    df_print: paged
editor_options:
  chunk_output_type: console
---

```{r, include = FALSE, echo = FALSE}

knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)

require(tidyverse)
require(sf)
#library(arcgisbinding)
library(tmap)
library(kableExtra)
library(rpgcolorsr)
library(tmaptools)
library(rmapshaper)

epsg <- 2236

tmap_mode("view")

#arc.check_product()

options(scipen=999)

model_zones <- st_read("K://Projects//D4_CSHnetwork//Features//LU//SPCC_20//data_prep//cleaned_data//models//models_dem.shp", quiet = T) %>% 
  mutate(acres = as.numeric(st_area(.))/43560,
         Emp_45_den = Emp_45 / acres,
         c5_emp = if_else(Emp_45_den > 20, "yes", "no")) %>% 
  dplyr::select(AZ_ID, Emp_45_den, c5_emp)

grid_with_summary <- readRDS("K:/Projects/D4_CSHnetwork/Features/LU/SPCC_20/data_prep/demo_data/services_count_overlay/services_count_grid.rds") %>% 
  st_filter(model_zones,
            .predicate = st_intersects)

merged_points <- readRDS("K:/Projects/D4_CSHnetwork/Features/LU/SPCC_20/data_prep/demo_data/services_count_overlay/services_merged_points.rds") %>% 
  st_filter(model_zones,
            .predicate = st_intersects)

  
```

## Summary

The purpose of this page is to review the method and process for acquiring and summarizing service-oriented POIs in the D4 region.

## Input Data

The following POIs were queried from Open Street Map:

-   Town Hall
-   Post Office
-   Police
-   Fire Station
-   Courthouse
-   Government

The following POIs were obtained from FGDL:

-   Library
-   Theaters & Performing Arts Center
-   Museums & Art Galleries

The following model SE data is used to filter POI clusters:

-   TCRPM5 and SERPM8 zones with employment density greater than 20 jobs / acre.

## Analysis

500-foot grid cells were created. The number of unique POI categories within 1,000 feet from the center of each cell was calculated, returning a value of 0-7 for each cell, with 7 representing all POI category types are present, and 0 representing no POI category types are present.

Finally, these areas are mapped with zones that contain the C5 employment threshold or greater of at least 20 jobs per acre.

### Summary of Results

```{r}

three_plus_points <- grid_with_summary %>% 
  filter(count > 2) %>%
  ms_dissolve() %>% 
  ms_explode() %>% 
  st_centroid() %>% 
  rename(geometry = x)

three_plus_gird <- grid_with_summary %>% 
  filter(count > 2)

geocoded_points <- rev_geocode_OSM(three_plus_points, projection = 2236)

geocoded_points <- geocoded_points %>%
  mutate(display_name = if_else(is.na(town),
                                if_else(is.na(suburb), village, suburb),town),
         display_name = if_else(is.na(display_name), city, display_name),
         display_name = if_else(is.na(display_name),
           case_when(office == "City of Coral Springs City Hall" ~ "Coral Springs"), display_name))
           

points_with_geocode <- cbind(three_plus_points, geocoded_points) %>%
  ungroup() %>% 
  mutate(point_id = row_number())

emp_density_per_point <- points_with_geocode %>% 
  st_buffer(2640) %>%
  mutate(buffer_area = as.numeric(st_area(.))) %>% 
  st_intersection(model_zones) %>% 
  mutate(intersect_area = as.numeric(st_area(.))) %>%
  st_drop_geometry() %>% 
  group_by(point_id, c5_emp) %>% 
  summarise(grouped_area = sum(intersect_area),
            buffer_area = first(buffer_area)) %>% 
  pivot_wider(names_from = "c5_emp",
              values_from = "grouped_area") %>% 
  replace(is.na(.), 0) %>% 
  mutate(buffer_calc = yes + no) %>% 
  mutate(pct_c5_emp = round((yes / buffer_calc) * 100, digits = 2)) %>% 
  dplyr::select(point_id, pct_c5_emp)

points_with_geocode <- left_join(points_with_geocode, 
                                 emp_density_per_point)

```

#### Map w/ POI clusters (w/ score with score of 3 or higher) w/ Percent of 1/2-mile Buffer that Meets C5+ Emp Density (20/ac+)
```{r}
tm_shape(points_with_geocode) + tm_dots(col = "pct_c5_emp", size = 0.1, style = "jenks", n = 7,
                                          perceptual = TRUE, palette = "-viridis") +
  tm_text("display_name", remove.overlap = TRUE, just = "bottom") +
  tm_add_legend(type = "fill", label = "Place w/ 3+ Categories by C5 Emp LU in Buffer", col = "#8400a8")
```



#### Map w/ POI clusters (w/ score with score of 3 or higher) + Zones w/ C5+ Employment Density
```{r}

model_zones_subset <- model_zones %>% 
  st_filter(st_buffer(points_with_geocode, 2640),
            .predicate = st_intersects)

tm_shape(model_zones_subset) + tm_polygons(col = "c5_emp", alpha = 0.5,
                                      palette = c("#ea425a", "#96a821"),
                                    title = "Zones w/ C5+ Emp Den",
                                    popup.vars = c("Emp_45_den")) + tm_shape(three_plus_gird) + tm_borders(col = "#8400a8") +
  tm_shape(points_with_geocode) + tm_dots(col = "#8400a8", size = 0.1,
                                          perceptual = TRUE) +
  tm_text("display_name", remove.overlap = TRUE, just = "bottom") +
  tm_add_legend(type = "fill", label = "Place w/ 3+ Categories", col = "#8400a8")
```


#### Table of Places With 3+ POI Categories Within 1,000 Feet

```{r}

points_with_geocode %>%
  st_drop_geometry() %>%
  distinct(county, display_name, pct_c5_emp) %>% 
  kbl(col.names = c("County", "Place Name", "% of 1/2 mi buffer w/ C5+ Emp Den")) %>% 
  kable_paper("hover", full_width = F)

```

#### Map of all POIs + summarized grid cells

*Note: you may need to zoom in to see grid cells.*

```{r}


tm_shape(grid_with_summary) + tm_fill(col = "count", palette = "-inferno") +
  tm_shape(merged_points) + tm_dots(col = "type", border.lwd = 0,
                                  palette = "viridis")

```
